# ğŸ¥ Kiwi è¯­éŸ³åŠ©æ‰‹

åŸºäºäº‹ä»¶é©±åŠ¨æ¶æ„çš„æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹ç³»ç»Ÿ

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡

### ç³»ç»Ÿæ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     SystemController (ä¸­å¤®æ€»çº¿)      â”‚
â”‚  â€¢ æ¨¡å—æ³¨å†Œä¸ç®¡ç†                     â”‚
â”‚  â€¢ äº‹ä»¶å‘å¸ƒä¸è®¢é˜…                     â”‚
â”‚  â€¢ çŠ¶æ€åè°ƒ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
  â–¼         â–¼         â–¼        â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Audio â”‚ â”‚Wake  â”‚ â”‚ VAD  â”‚ â”‚ ASR  â”‚ â”‚ GUI  â”‚
â”‚      â”‚ â”‚word  â”‚ â”‚      â”‚ â”‚      â”‚ â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸåˆ™

1. **å®Œå…¨è§£è€¦**: æ¨¡å—ä¹‹é—´æ— ç›´æ¥ä¾èµ–ï¼Œé€šè¿‡äº‹ä»¶é€šä¿¡
2. **äº‹ä»¶é©±åŠ¨**: æ‰€æœ‰æ¨¡å—é€šä¿¡é€šè¿‡ä¸­å¤®äº‹ä»¶æ€»çº¿
3. **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰æ¨¡å—å®ç° `IModule` æ¥å£
4. **çŠ¶æ€ç®¡ç†**: é›†ä¸­å¼çŠ¶æ€æœºç®¡ç†è¯­éŸ³å¤„ç†æµç¨‹
5. **å¯æ‰©å±•**: é€šè¿‡é€‚é…å™¨æ¨¡å¼è½»æ¾æ¥å…¥æ–°æ¨¡å—

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—

### 1. SystemController (ç³»ç»Ÿæ§åˆ¶å™¨)

**èŒè´£:**
- æ¨¡å—ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆæ³¨å†Œã€åˆå§‹åŒ–ã€å¯åŠ¨ã€åœæ­¢ï¼‰
- äº‹ä»¶æ€»çº¿ï¼ˆå‘å¸ƒ/è®¢é˜…æœºåˆ¶ï¼‰
- çŠ¶æ€åè°ƒï¼ˆé€šè¿‡ VoiceStateManagerï¼‰

**æ ¸å¿ƒæ–¹æ³•:**
```python
controller.register_module(module)    # æ³¨å†Œæ¨¡å—
controller.publish_event(event, data) # å‘å¸ƒäº‹ä»¶
controller.initialize_all(config)     # åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
controller.start_all()                # å¯åŠ¨æ‰€æœ‰æ¨¡å—
```

### 2. Audio Module (éŸ³é¢‘æ¨¡å—)

**èŒè´£:**
- éŸ³é¢‘é‡‡é›†ï¼ˆéº¦å…‹é£è¾“å…¥ï¼‰
- éŸ³é¢‘æµåˆ†å‘ï¼ˆå‘å¸ƒ AUDIO_FRAME_READY äº‹ä»¶ï¼‰

**äº‹ä»¶:**
- å‘å¸ƒ: `AUDIO_FRAME_READY` - éŸ³é¢‘å¸§å‡†å¤‡å°±ç»ª

### 3. Wakeword Module (å”¤é†’è¯æ¨¡å—)

**èŒè´£:**
- å”¤é†’è¯æ£€æµ‹ï¼ˆåŸºäº OpenWakeWordï¼‰
- è§¦å‘ç³»ç»Ÿè¿›å…¥ç›‘å¬çŠ¶æ€

**äº‹ä»¶:**
- è®¢é˜…: `AUDIO_FRAME_READY`
- å‘å¸ƒ: `WAKEWORD_DETECTED` - æ£€æµ‹åˆ°å”¤é†’è¯

### 4. VAD Module (è¯­éŸ³æ´»åŠ¨æ£€æµ‹)

**èŒè´£:**
- æ£€æµ‹è¯­éŸ³å¼€å§‹å’Œç»“æŸ
- å”¤é†’åå»¶è¿Ÿæœºåˆ¶ï¼ˆ500msï¼‰
- è¿ç»­é™éŸ³åˆ¤å®šï¼ˆ1000msï¼‰

**äº‹ä»¶:**
- è®¢é˜…: `AUDIO_FRAME_READY`, `WAKEWORD_DETECTED`, `WAKEWORD_RESET`
- å‘å¸ƒ: `VAD_SPEECH_START`, `VAD_SPEECH_END`

**å…³é”®é€»è¾‘:**
```python
# å”¤é†’åå»¶è¿Ÿ 500ms å¼€å§‹ VAD æ£€æµ‹
wakeword_delay_ms = 500

# è¿ç»­é™éŸ³ 1000ms è§¦å‘ VAD END
vad_end_silence_ms = 1000
```

### 5. ASR Module (è¯­éŸ³è¯†åˆ«)

**èŒè´£:**
- è¯­éŸ³è½¬æ–‡å­—ï¼ˆåŸºäº Whisperï¼‰
- éŸ³é¢‘ç¼“å†²å’Œè¯†åˆ«è§¦å‘

**äº‹ä»¶:**
- è®¢é˜…: `AUDIO_FRAME_READY`, `VAD_SPEECH_START`, `VAD_SPEECH_END`
- å‘å¸ƒ: `ASR_RECOGNITION_SUCCESS`, `ASR_RECOGNITION_FAILED`

### 6. GUI Module (å›¾å½¢ç•Œé¢)

**èŒè´£:**
- å®æ—¶æ³¢å½¢æ˜¾ç¤º
- FFT é¢‘è°±åˆ†æ
- VAD çŠ¶æ€å¯è§†åŒ–
- ASR ç»“æœå±•ç¤º

**äº‹ä»¶:**
- è®¢é˜…: æ‰€æœ‰äº‹ä»¶ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰

### 7. VoiceStateManager (çŠ¶æ€æœº)

**èŒè´£:**
- ç®¡ç†è¯­éŸ³å¤„ç†æµç¨‹çŠ¶æ€
- çŠ¶æ€è½¬æ¢é€»è¾‘
- VAD END è®¡æ•°å’Œé‡ç½®

**çŠ¶æ€å®šä¹‰:**
```python
IDLE              # ç©ºé—²ï¼Œç­‰å¾…å”¤é†’è¯
WAKEWORD_DETECTED # æ£€æµ‹åˆ°å”¤é†’è¯
LISTENING         # ç›‘å¬ä¸­
SPEECH_DETECTED   # æ£€æµ‹åˆ°è¯­éŸ³
RECOGNIZING       # è¯†åˆ«ä¸­
```

## ğŸ”„ ç³»ç»Ÿæµç¨‹

### å®Œæ•´äº¤äº’æµç¨‹

```
1. ç³»ç»Ÿå¯åŠ¨
   â””â”€> [IDLE] ç­‰å¾…å”¤é†’è¯

2. ç”¨æˆ·è¯´"å°æ™ºåŒå­¦"
   â””â”€> Wakeword æ£€æµ‹
       â””â”€> å‘å¸ƒ WAKEWORD_DETECTED
           â””â”€> [WAKEWORD_DETECTED]

3. å»¶è¿Ÿ 500ms
   â””â”€> VAD å¼€å§‹æ£€æµ‹
       â””â”€> [LISTENING]

4. ç”¨æˆ·å¼€å§‹è¯´è¯
   â””â”€> VAD æ£€æµ‹åˆ°è¯­éŸ³
       â””â”€> å‘å¸ƒ VAD_SPEECH_START
           â””â”€> [SPEECH_DETECTED]
           â””â”€> ASR å¼€å§‹ç¼“å†²éŸ³é¢‘

5. ç”¨æˆ·è¯´è¯ä¸­...
   â””â”€> æŒç»­é‡‡é›†éŸ³é¢‘å¸§

6. è¿ç»­é™éŸ³ 1000ms
   â””â”€> VAD è§¦å‘ç»“æŸ
       â””â”€> å‘å¸ƒ VAD_SPEECH_END
           â””â”€> [IDLE] (max_vad_end_count=1)
           â””â”€> ASR å¼€å§‹è¯†åˆ«

7. ASR è¯†åˆ«å®Œæˆ
   â””â”€> å‘å¸ƒ ASR_RECOGNITION_SUCCESS
       â””â”€> GUI æ˜¾ç¤ºç»“æœ

8. è¿”å› [IDLE]
   â””â”€> ç­‰å¾…ä¸‹ä¸€æ¬¡å”¤é†’
```

### çŠ¶æ€è½¬æ¢å›¾

```mermaid
graph TD
    A[IDLE ç©ºé—²] -->|å”¤é†’è¯| B[WAKEWORD_DETECTED]
    B -->|500mså»¶è¿Ÿ| C[LISTENING ç›‘å¬]
    C -->|æ£€æµ‹åˆ°è¯­éŸ³| D[SPEECH_DETECTED]
    D -->|VAD END| E{åˆ¤æ–­æ¬¡æ•°}
    E -->|è¾¾åˆ°max_vad_end_count| F[è§¦å‘ASR]
    F --> G[RECOGNIZING]
    G -->|è¯†åˆ«å®Œæˆ| A
    E -->|æœªè¾¾åˆ°| C
```

### äº‹ä»¶æµç¨‹å›¾

```
AUDIOé‡‡é›†
    â†“
AUDIO_FRAME_READY äº‹ä»¶
    â†“
    â”œâ”€> Wakeword æ¨¡å—
    â”‚   â””â”€> WAKEWORD_DETECTED äº‹ä»¶
    â”‚       â””â”€> çŠ¶æ€æœº: IDLE â†’ WAKEWORD_DETECTED
    â”‚
    â”œâ”€> VAD æ¨¡å—
    â”‚   â”œâ”€> VAD_SPEECH_START äº‹ä»¶
    â”‚   â”‚   â””â”€> çŠ¶æ€æœº: LISTENING â†’ SPEECH_DETECTED
    â”‚   â””â”€> VAD_SPEECH_END äº‹ä»¶
    â”‚       â””â”€> çŠ¶æ€æœº: SPEECH_DETECTED â†’ IDLE
    â”‚       â””â”€> è§¦å‘ ASR
    â”‚
    â””â”€> ASR æ¨¡å—
        â””â”€> ASR_RECOGNITION_SUCCESS äº‹ä»¶
            â””â”€> GUI æ˜¾ç¤ºç»“æœ
```

## ğŸ¯ å…³é”®é…ç½®

### VAD é…ç½®
```yaml
vad:
  settings:
    wakeword_delay_ms: 500      # å”¤é†’åå»¶è¿Ÿ
    vad_end_silence_ms: 1000    # é™éŸ³åˆ¤å®šæ—¶é•¿
    frame_duration_ms: 30       # å¸§æ—¶é•¿
    aggressiveness: 2           # æ¿€è¿›åº¦ (0-3)
```

### çŠ¶æ€æœºé…ç½®
```python
StateConfig(
    enable_wakeword=True,       # å¯ç”¨å”¤é†’è¯
    max_vad_end_count=1,        # ä¸€æ¬¡ VAD END å°±é‡ç½®
    wakeword_timeout=10.0       # å”¤é†’è¶…æ—¶æ—¶é—´
)
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¯åŠ¨ GUI
python main.py
```

## ğŸ“Š GUI çŠ¶æ€æ˜¾ç¤º

| çŠ¶æ€ | æ˜¾ç¤º | è¯´æ˜ |
|------|------|------|
| å°±ç»ª | `Status: ready` | ç³»ç»Ÿç›‘å¬ä¸­ |
| å”¤é†’ | `Status: wake up` | æ£€æµ‹åˆ°å”¤é†’è¯ |
| VADå¼€å§‹ | `Status: vad begin` | æ£€æµ‹åˆ°è¯­éŸ³æ´»åŠ¨ |
| VADç»“æŸ | `Status: vad end` | è¯­éŸ³æ´»åŠ¨ç»“æŸ |
| è¿”å›å°±ç»ª | `Status: ready` | 100msåè‡ªåŠ¨åˆ‡æ¢ |

## ğŸ“ é¡¹ç›®ç»“æ„

```
kiwi/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒæ¡†æ¶
â”‚   â”‚   â”œâ”€â”€ controller.py       # ç³»ç»Ÿæ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ events.py           # äº‹ä»¶å®šä¹‰
â”‚   â”‚   â””â”€â”€ interfaces.py       # æ¨¡å—æ¥å£
â”‚   â”œâ”€â”€ adapters/               # æ¨¡å—é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ audio_adapter.py
â”‚   â”‚   â”œâ”€â”€ wakeword_adapter.py
â”‚   â”‚   â”œâ”€â”€ vad_adapter.py
â”‚   â”‚   â”œâ”€â”€ asr_adapter.py
â”‚   â”‚   â””â”€â”€ gui_adapter.py
â”‚   â”œâ”€â”€ state_machine/          # çŠ¶æ€æœº
â”‚   â”‚   â”œâ”€â”€ manager.py
â”‚   â”‚   â””â”€â”€ types.py
â”‚   â”œâ”€â”€ audio/                  # éŸ³é¢‘å¼•æ“
â”‚   â”œâ”€â”€ wakeword/               # å”¤é†’è¯å¼•æ“
â”‚   â”œâ”€â”€ vad/                    # VAD å¼•æ“
â”‚   â”œâ”€â”€ asr/                    # ASR å¼•æ“
â”‚   â””â”€â”€ gui/                    # GUI ç•Œé¢
â”œâ”€â”€ config/                     # é…ç½®æ–‡ä»¶
â”œâ”€â”€ models/                     # æ¨¡å‹æ–‡ä»¶
â””â”€â”€ main.py                     # ç¨‹åºå…¥å£
```

## ğŸ¨ æŠ€æœ¯æ ˆ

- **äº‹ä»¶ç³»ç»Ÿ**: è‡ªç ”äº‹ä»¶æ€»çº¿
- **å”¤é†’è¯**: OpenWakeWord
- **VAD**: WebRTC VAD
- **ASR**: OpenAI Whisper
- **GUI**: PyQt5 + pyqtgraph
- **éŸ³é¢‘**: PyAudio

## ğŸ“„ è®¸å¯

MIT License
