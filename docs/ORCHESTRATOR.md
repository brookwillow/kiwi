# Orchestrator æ¨¡å—

ç¼–æ’è€…æ¨¡å—ï¼Œè´Ÿè´£æ¥æ”¶ç”¨æˆ·æŸ¥è¯¢ï¼Œå¬å›ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶é€šè¿‡LLMå†³ç­–é€‰æ‹©æœ€åˆé€‚çš„Agentæ¥å¤„ç†ä»»åŠ¡ã€‚

## ğŸ“¦ æ¨¡å—èŒè´£

### 1. æ¥æ”¶è¾“å…¥
- **ç”¨æˆ·æŸ¥è¯¢**: æ¥è‡ªASRè¯†åˆ«çš„ç”¨æˆ·è¯­éŸ³å†…å®¹
- **ç³»ç»Ÿäº‹ä»¶**: ç”¨æˆ·è§¦å‘çš„ç³»ç»Ÿäº‹ä»¶ï¼ˆå¦‚æŒ‰é’®ç‚¹å‡»ç­‰ï¼‰

### 2. ä¸Šä¸‹æ–‡å¬å›

#### çŸ­æœŸè®°å¿†ï¼ˆå¯¹è¯å†å²ï¼‰
- å­˜å‚¨æœ€è¿‘çš„å¯¹è¯è®°å½•
- æ ¹æ®æŸ¥è¯¢ç›¸å…³æ€§å¬å›
- é»˜è®¤ä¿ç•™æœ€è¿‘10æ¡è®°å¿†

#### é•¿æœŸè®°å¿†ï¼ˆç”¨æˆ·ç”»åƒï¼‰
- å¯¹è¯æ‘˜è¦
- ç”¨æˆ·åå¥½è®¾ç½®
- ç”¨æˆ·ç”»åƒä¿¡æ¯

#### ç³»ç»ŸçŠ¶æ€ï¼ˆæ„ŸçŸ¥ï¼‰
- è½¦è¾†çŠ¶æ€ï¼ˆé€Ÿåº¦ã€æ²¹é‡ã€æ¸©åº¦ç­‰ï¼‰
- éŸ³ä¹çŠ¶æ€ï¼ˆæ’­æ”¾ä¸­çš„æ­Œæ›²ã€éŸ³é‡ç­‰ï¼‰
- å¯¼èˆªçŠ¶æ€ï¼ˆç›®çš„åœ°ã€å‰©ä½™è·ç¦»ç­‰ï¼‰
- ç©ºè°ƒçŠ¶æ€ï¼ˆæ¸©åº¦ã€é£é€Ÿç­‰ï¼‰
- ç¯å¢ƒçŠ¶æ€ï¼ˆå¤©æ°”ã€ä½ç½®ç­‰ï¼‰

### 3. Agentä¿¡æ¯
- è·å–æ‰€æœ‰å¯ç”¨çš„Agents
- æ¯ä¸ªAgentçš„æè¿°å’Œèƒ½åŠ›åˆ—è¡¨
- Agentçš„å¯ç”¨çŠ¶æ€

### 4. LLMå†³ç­–
- ä½¿ç”¨é˜¿é‡Œç™¾ç‚¼å¹³å°çš„é€šä¹‰åƒé—®æ¨¡å‹
- åŸºäºæ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œæ™ºèƒ½å†³ç­–
- è¿”å›é€‰ä¸­çš„Agentã€ç½®ä¿¡åº¦å’Œå†³ç­–ç†ç”±

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Orchestrator                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. æ¥æ”¶ç”¨æˆ·æŸ¥è¯¢æˆ–ç³»ç»Ÿäº‹ä»¶        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. å¬å›ä¸Šä¸‹æ–‡                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ çŸ­æœŸè®°å¿†ï¼ˆå¯¹è¯å†å²ï¼‰          â”‚  â”‚
â”‚  â”‚  â”œâ”€ é•¿æœŸè®°å¿†ï¼ˆç”¨æˆ·ç”»åƒï¼‰          â”‚  â”‚
â”‚  â”‚  â”œâ”€ ç³»ç»ŸçŠ¶æ€ï¼ˆæ„ŸçŸ¥ï¼‰              â”‚  â”‚
â”‚  â”‚  â””â”€ å¯ç”¨Agentsä¿¡æ¯                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. LLMå†³ç­–                        â”‚  â”‚
â”‚  â”‚  â””â”€ é˜¿é‡Œç™¾ç‚¼é€šä¹‰åƒé—®               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  4. è¿”å›å†³ç­–ç»“æœ                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ é€‰ä¸­çš„Agent                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ ç½®ä¿¡åº¦                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ å†³ç­–ç†ç”±                       â”‚  â”‚
â”‚  â”‚  â””â”€ å‚æ•°                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ¨¡å—ç»“æ„

```
orchestrator/
â”œâ”€â”€ __init__.py              # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ types.py                 # ç±»å‹å®šä¹‰
â”œâ”€â”€ orchestrator.py          # ä¸»ç¼–æ’å™¨
â”œâ”€â”€ memory_manager.py        # è®°å¿†ç®¡ç†å™¨
â”œâ”€â”€ perception_manager.py    # æ„ŸçŸ¥ç®¡ç†å™¨
â”œâ”€â”€ agent_manager.py         # Agentç®¡ç†å™¨
â””â”€â”€ llm_decision.py          # LLMå†³ç­–å™¨
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```python
from src.orchestrator import (
    Orchestrator,
    create_mock_memory_manager,
    create_mock_perception_manager,
    create_mock_agent_manager
)

# åˆ›å»ºOrchestratorï¼ˆä½¿ç”¨æ¨¡æ‹ŸLLMï¼‰
orchestrator = Orchestrator(
    memory_manager=create_mock_memory_manager(),
    perception_manager=create_mock_perception_manager(),
    agent_manager=create_mock_agent_manager(),
    use_mock_llm=True
)

# å¤„ç†ç”¨æˆ·æŸ¥è¯¢
decision = orchestrator.process_query("æ’­æ”¾å‘¨æ°ä¼¦çš„æ™´å¤©")

print(f"é€‰ä¸­Agent: {decision.selected_agent}")
print(f"ç½®ä¿¡åº¦: {decision.confidence}")
print(f"å†³ç­–ç†ç”±: {decision.reasoning}")
```

### 2. ä½¿ç”¨çœŸå®LLM

```python
import os

# è®¾ç½®API Key
api_key = os.getenv("DASHSCOPE_API_KEY")

# åˆ›å»ºOrchestrator
orchestrator = Orchestrator(
    memory_manager=create_mock_memory_manager(),
    perception_manager=create_mock_perception_manager(),
    agent_manager=create_mock_agent_manager(),
    llm_api_key=api_key,
    use_mock_llm=False
)

# å¤„ç†æŸ¥è¯¢
decision = orchestrator.process_query("å¯¼èˆªåˆ°å…¬å¸")
```

### 3. ä»é…ç½®æ–‡ä»¶åŠ è½½Agent

```python
from src.orchestrator import AgentManager

# ä»é…ç½®æ–‡ä»¶åŠ è½½
agent_manager = AgentManager(config_path="config/agents_config.yaml")

# åˆ›å»ºOrchestrator
orchestrator = Orchestrator(
    agent_manager=agent_manager,
    use_mock_llm=True
)
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
# åŸºæœ¬æµ‹è¯•
python test_orchestrator.py

# è®¾ç½®API Keyåæµ‹è¯•çœŸå®LLM
export DASHSCOPE_API_KEY='your-api-key'
python test_orchestrator.py
```

æµ‹è¯•å†…å®¹ï¼š
- âœ… æ¨¡æ‹ŸLLMå†³ç­–æµ‹è¯•
- âœ… ä»é…ç½®æ–‡ä»¶åŠ è½½Agentæµ‹è¯•
- âœ… çœŸå®LLMå†³ç­–æµ‹è¯•ï¼ˆéœ€è¦API Keyï¼‰
- âœ… äº¤äº’å¼æµ‹è¯•

## ğŸ“Š æ ¸å¿ƒç±»å‹

### OrchestratorInput
```python
@dataclass
class OrchestratorInput:
    query_type: QueryType          # æŸ¥è¯¢ç±»å‹
    query_content: str             # æŸ¥è¯¢å†…å®¹
    timestamp: float               # æ—¶é—´æˆ³
    metadata: Dict[str, Any]       # å…ƒæ•°æ®
```

### OrchestratorContext
```python
@dataclass
class OrchestratorContext:
    input_query: OrchestratorInput
    short_term_memories: List[ShortTermMemory]
    long_term_memory: Optional[LongTermMemory]
    system_states: List[SystemState]
    available_agents: List[AgentInfo]
```

### OrchestratorDecision
```python
@dataclass
class OrchestratorDecision:
    selected_agent: str            # é€‰ä¸­çš„Agentåç§°
    confidence: float              # ç½®ä¿¡åº¦
    reasoning: str                 # å†³ç­–ç†ç”±
    parameters: Dict[str, Any]     # ä¼ é€’ç»™Agentçš„å‚æ•°
    metadata: Dict[str, Any]       # å…ƒæ•°æ®
```

## âš™ï¸ é…ç½®

### orchestrator_config.yaml

```yaml
orchestrator:
  # LLMé…ç½®
  llm:
    provider: "dashscope"
    model: "qwen-plus"
    temperature: 0.3
    
  # è®°å¿†é…ç½®
  memory:
    max_short_term: 10
    max_recall_count: 5
    
  # å†³ç­–é…ç½®
  decision:
    min_confidence: 0.5
    default_agent: "chat_agent"
    use_mock_llm: true
```

### agents_config.yaml

```yaml
agents:
  - name: "music_agent"
    description: "éŸ³ä¹æ’­æ”¾å’Œæ§åˆ¶Agent"
    enabled: true
    capabilities:
      - "æ’­æ”¾éŸ³ä¹"
      - "æš‚åœéŸ³ä¹"
      - "è°ƒèŠ‚éŸ³é‡"
```

## ğŸ¯ è®¾è®¡ç‰¹ç‚¹

### 1. æ¨¡å—åŒ–è®¾è®¡
- **MemoryManager**: ç‹¬ç«‹çš„è®°å¿†ç®¡ç†
- **PerceptionManager**: ç‹¬ç«‹çš„æ„ŸçŸ¥ç®¡ç†
- **AgentManager**: ç‹¬ç«‹çš„Agentç®¡ç†
- **LLMDecisionMaker**: ç‹¬ç«‹çš„å†³ç­–å¼•æ“

### 2. å¯æ‰©å±•æ€§
- æ”¯æŒè‡ªå®šä¹‰è®°å¿†å¬å›ç­–ç•¥
- æ”¯æŒè‡ªå®šä¹‰ç³»ç»ŸçŠ¶æ€ç±»å‹
- æ”¯æŒåŠ¨æ€æ³¨å†Œå’Œå¯ç”¨/ç¦ç”¨Agent
- æ”¯æŒåˆ‡æ¢ä¸åŒçš„LLMæä¾›å•†

### 3. çµæ´»é…ç½®
- æ”¯æŒä»é…ç½®æ–‡ä»¶åŠ è½½
- æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€é…ç½®
- æ”¯æŒæ¨¡æ‹Ÿæ¨¡å¼å’ŒçœŸå®æ¨¡å¼åˆ‡æ¢

### 4. æµ‹è¯•å‹å¥½
- æä¾›æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨
- æä¾›æ¨¡æ‹ŸLLMå†³ç­–å™¨
- æ”¯æŒç‹¬ç«‹æµ‹è¯•å„ä¸ªç»„ä»¶

## ğŸ”„ å…¸å‹æµç¨‹

```
1. ç”¨æˆ·è¯´ï¼š"æ’­æ”¾å‘¨æ°ä¼¦çš„æ™´å¤©"
   â†“
2. Orchestratoræ¥æ”¶æŸ¥è¯¢
   â†“
3. å¬å›ä¸Šä¸‹æ–‡ï¼š
   - çŸ­æœŸè®°å¿†ï¼šç”¨æˆ·ä¹‹å‰å¬è¿‡å‘¨æ°ä¼¦çš„æ­Œ
   - é•¿æœŸè®°å¿†ï¼šç”¨æˆ·æ˜¯å‘¨æ°ä¼¦æ­Œè¿·
   - ç³»ç»ŸçŠ¶æ€ï¼šéŸ³ä¹æ­£åœ¨æ’­æ”¾ã€Šç¨»é¦™ã€‹
   - å¯ç”¨Agentsï¼šmusic_agent, navigation_agentç­‰
   â†“
4. LLMåˆ†æå†³ç­–ï¼š
   - åˆ†æï¼šç”¨æˆ·æƒ³æ’­æ”¾ç‰¹å®šæ­Œæ›²
   - é€‰æ‹©ï¼šmusic_agent
   - ç½®ä¿¡åº¦ï¼š0.95
   - ç†ç”±ï¼šæ˜ç¡®çš„éŸ³ä¹æ’­æ”¾è¯·æ±‚
   â†“
5. è¿”å›å†³ç­–ç»“æœ
   â†“
6. ç³»ç»Ÿå°†ä»»åŠ¡åˆ†é…ç»™music_agentæ‰§è¡Œ
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **API Keyé…ç½®**
   - ä½¿ç”¨çœŸå®LLMéœ€è¦é…ç½®DASHSCOPE_API_KEY
   - å¯é€šè¿‡ç¯å¢ƒå˜é‡æˆ–ä»£ç ä¼ å…¥

2. **æ¨¡æ‹Ÿæ¨¡å¼**
   - å¼€å‘å’Œæµ‹è¯•æ—¶å»ºè®®ä½¿ç”¨æ¨¡æ‹ŸLLM
   - æ¨¡æ‹Ÿæ¨¡å¼ä½¿ç”¨ç®€å•çš„å…³é”®è¯åŒ¹é…

3. **è®°å¿†å’Œæ„ŸçŸ¥**
   - å½“å‰ä¸ºæ¨¡æ‹Ÿå®ç°
   - åç»­å¯æ¥å…¥çœŸå®çš„è®°å¿†å’Œæ„ŸçŸ¥æ¨¡å—

4. **æ‰©å±•Agent**
   - åœ¨agents_config.yamlä¸­æ·»åŠ æ–°Agent
   - ç¡®ä¿æä¾›æè¿°å’Œèƒ½åŠ›åˆ—è¡¨

## ğŸ“„ è®¸å¯

MIT License
